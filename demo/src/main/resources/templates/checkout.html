<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/header :: head}">
    <title>Finalizar Compra - La Real 394</title>
</head>

<body>
    <div th:replace="~{fragments/header :: topbar}"></div>
    <nav th:replace="~{fragments/header :: navbar(active='carrito')}"></nav>

    <section class="contact-hero">
        <div class="container">
            <div class="contact-hero-content">
                <h1>Finalizar Compra</h1>
                <p>Elige tu método de pago preferido</p>
            </div>
        </div>
    </section>

    <main class="checkout-main espaciado section-light-bg">
        <div class="contenedor">
            <div class="checkout-grid">

                <div class="checkout-form-container">

                    <div class="checkout-card">
                        <div class="checkout-header">
                            <div class="step-number">1</div>
                            <h3>Datos de Envío</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dirección de entrega</label>
                            <input type="text" class="form-control-custom" value="Av. La Real 394, Lima" readonly>
                            <small style="color: var(--color3); display:block; margin-top:5px;">
                                <i class="fa-solid fa-map-pin"></i> Dirección predeterminada del cliente
                            </small>
                        </div>
                    </div>

                    <div class="checkout-card">
                        <div class="checkout-header">
                            <div class="step-number">2</div>
                            <h3>Método de Pago</h3>
                        </div>

                        <div class="payment-selector">
                            <label class="payment-option">
                                <input type="radio" name="metodoPago" value="tarjeta" checked onchange="togglePaymentMethod('tarjeta')">
                                <div class="payment-box">
                                    <div class="icon-wrapper"><i class="fa-regular fa-credit-card"></i></div>
                                    <span>Tarjeta</span>
                                </div>
                            </label>
                            <label class="payment-option">
                                <input type="radio" name="metodoPago" value="yape" onchange="togglePaymentMethod('yape')">
                                <div class="payment-box">
                                    <div class="icon-wrapper yape-color"><i class="fa-solid fa-qrcode"></i></div>
                                    <span>Yape / Plin</span>
                                </div>
                            </label>
                        </div>

                        <div id="form-tarjeta" class="payment-details-section active">
                            <div class="card-visual-wrapper">
                                <div class="credit-card-visual">
                                    <div class="card-front">
                                        <div class="card-chip"></div>
                                        <div class="card-logo" id="card-logo-visual"><i class="fa-brands fa-cc-visa"></i></div>
                                        <div class="card-number-display" id="display-number">#### #### #### ####</div>
                                        <div class="card-details-row">
                                            <div class="card-holder">
                                                <span>Titular</span>
                                                <div id="display-name">NOMBRE APELLIDO</div>
                                            </div>
                                            <div class="card-expires">
                                                <span>Expira</span>
                                                <div id="display-expiry">MM/YY</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <form id="paymentFormCard" class="card-input-form">
                                <div class="form-group">
                                    <label>Número de Tarjeta</label>
                                    <div class="input-with-icon">
                                        <input type="text" id="cardNumber" maxlength="19" placeholder="0000 0000 0000 0000" class="form-control-custom" required>
                                        <i class="fa-regular fa-credit-card input-icon" id="card-type-icon"></i>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Nombre del Titular</label>
                                    <input type="text" id="cardName" placeholder="Como figura en la tarjeta" class="form-control-custom" style="text-transform: uppercase;" required>
                                </div>

                                <div class="form-row-split">
                                    <div class="form-group">
                                        <label>Vencimiento</label>
                                        <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5" class="form-control-custom" required>
                                    </div>
                                    <div class="form-group">
                                        <label>CVV</label>
                                        <input type="password" id="cardCvv" placeholder="123" maxlength="3" class="form-control-custom" required>
                                    </div>
                                </div>

                                <div class="secure-badge">
                                    <i class="fa-solid fa-lock"></i> Pagos procesados de forma segura con SSL.
                                </div>

                                <button type="submit" class="btn-submit w-100" id="btn-pay-card">
                                    Pagar S/ <span th:text="${#numbers.formatDecimal(totalPagar, 1, 2)}"></span>
                                </button>
                            </form>
                        </div>

                        <div id="form-yape" class="payment-details-section">
                            <div class="yape-container">
                                <div class="qr-box">
                                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=LaReal394-Pago-Orden123" alt="QR Yape" class="qr-image">
                                </div>
                                <p class="qr-footer-text">QR de LaReal394</p>

                                <div class="yape-instructions">
                                    <h4>¡Escanea para pagar!</h4>
                                    <ol>
                                        <li>Abre tu app <strong>Yape</strong> o <strong>Plin</strong>.</li>
                                        <li>Escanea el código QR de arriba.</li>
                                        <li>El monto a pagar es: <strong class="price-highlight">S/ <span th:text="${#numbers.formatDecimal(totalPagar, 1, 2)}"></span></strong></li>
                                        <li>Presiona el botón "Ya realicé el pago" abajo.</li>
                                    </ol>
                                </div>

                                <button type="button" class="btn-yape" id="btn-pay-yape" onclick="procesarSimulacionYape()">
                                    <i class="fa-solid fa-check"></i> Ya realicé el pago
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="checkout-summary-container">
                    <div class="resumen-card sticky-top">
                        <div class="resumen-header">
                            <h3>Resumen de Compra</h3>
                            <p class="resumen-subtitle">La Real 394</p>
                        </div>
                        
                        <div class="resumen-items-list">
                            <div th:each="item : ${items}" class="resumen-item-row">
                                <div class="item-row-img">
                                    <img th:src="@{'/img/' + ${item.imagen}}" th:if="${item.imagen != null}" alt="img">
                                    <i class="fa-solid fa-burger" th:if="${item.imagen == null}"></i>
                                </div>
                                <div class="item-row-info">
                                    <span class="item-name" th:text="${item.nombre}">Item</span>
                                    <span class="item-qty">Cant: <span th:text="${item.cantidad}">1</span></span>
                                </div>
                                <div class="item-row-price">
                                    <span th:text="'S/ ' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}">0.00</span>
                                </div>
                            </div>
                        </div>

                        <div class="resumen-divider dashed"></div>

                        <div class="resumen-linea">
                            <span>Subtotal</span>
                            <span th:text="'S/ ' + ${#numbers.formatDecimal(total, 1, 2)}"></span>
                        </div>
                        <div class="resumen-linea">
                            <span>Delivery</span>
                            <span>S/ 5.00</span>
                        </div>
                        
                        <div class="resumen-divider"></div>
                        
                        <div class="resumen-total">
                            <span>Total a Pagar</span>
                            <span class="total-amount" th:text="'S/ ' + ${#numbers.formatDecimal(totalPagar, 1, 2)}"></span>
                        </div>

                        <div class="guarantee-box">
                            <i class="fa-solid fa-shield-halved"></i>
                            <span>Compra protegida</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="payment-overlay" class="loading-overlay">
        <div class="loader-content">
            <div class="spinner"></div>
            <h3 id="loading-text">Procesando pago...</h3>
            <p>Por favor no cierres esta ventana</p>
        </div>
    </div>

    <form id="realForm" th:action="@{/carrito/procesar-pago}" method="post" style="display:none;">
        <input type="hidden" name="metodoPago" id="inputMetodoPago" value="tarjeta">
    </form>

    <div th:replace="~{fragments/footer :: footer}"></div>
    <div th:replace="~{fragments/footer :: scripts}"></div>

    <style>
        /* --- 1. CENTRADO GENERAL DE LA PÁGINA --- */
        .checkout-main {
            display: flex;
            justify-content: center;
            width: 100%;
            align-items: flex-start;
        }

        .checkout-grid {
            display: grid;
            grid-template-columns: 1.6fr 1fr;
            gap: 40px;
            width: 100%;
            margin: 0 auto;
        }

        /* Tarjetas */
        .checkout-card, .resumen-card {
            background: var(--color2);
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            transition: transform 0.3s;
        }

        /* --- 2. CORRECCIÓN RESUMEN (STICKY) --- */
        .resumen-card.sticky-top {
            position: sticky;
            top: 120px !important; /* Empuja hacia abajo para no tapar el navbar */
            z-index: 90;
        }

        .resumen-card { padding: 30px; border: 1px solid #eee; }
        
        .resumen-header { text-align: center; margin-bottom: 20px; }
        .resumen-header h3 { font-size: 1.5rem; margin-bottom: 5px; color: var(--color4); }
        .resumen-subtitle { color: var(--color3); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; }

        /* Scrollbar Resumen */
        .resumen-items-list { max-height: 200px; overflow-y: auto; margin-bottom: 15px; padding-right: 5px; }
        .resumen-items-list::-webkit-scrollbar { width: 6px; }
        .resumen-items-list::-webkit-scrollbar-thumb { background-color: #ddd; border-radius: 4px; }

        /* Items en Resumen */
        .resumen-item-row { display: flex; align-items: center; margin-bottom: 15px; font-size: 0.9rem; }
        .item-row-img {
            width: 40px; height: 40px; border-radius: 8px; overflow: hidden; background: #f0f0f0;
            margin-right: 10px; display: flex; align-items: center; justify-content: center;
        }
        .item-row-img img { width: 100%; height: 100%; object-fit: cover; }
        .item-row-info { flex-grow: 1; display: flex; flex-direction: column; }
        .item-name { font-weight: 600; color: var(--color4); }
        .item-qty { font-size: 0.8rem; color: var(--color3); }
        .item-row-price { font-weight: 700; color: var(--color4); }

        .resumen-divider.dashed { border-top: 2px dashed #ddd; margin: 15px 0; }
        
        .resumen-total {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--color4);
        }
        .total-amount { font-size: 1.8rem; font-weight: 800; color: var(--color1); }

        .guarantee-box {
            margin-top: 20px; background: #f9f9f9; padding: 10px; border-radius: 10px;
            text-align: center; font-size: 0.85rem; color: #555;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        /* Formularios */
        .checkout-card { padding: 35px; }
        .checkout-header {
            display: flex; align-items: center; gap: 15px; margin-bottom: 25px;
            padding-bottom: 15px; border-bottom: 1px solid #eee;
        }
        .step-number {
            background: var(--color1); color: var(--color4); width: 35px; height: 35px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 1.1rem;
        }

        .payment-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .payment-option input { display: none; }
        .payment-box {
            border: 2px solid #eee; border-radius: 15px; padding: 20px;
            text-align: center; cursor: pointer; transition: all 0.3s;
        }
        .payment-option input:checked+.payment-box {
            border-color: var(--color1); background: rgba(255, 192, 0, 0.05);
            box-shadow: 0 5px 15px rgba(255, 192, 0, 0.15);
        }
        .icon-wrapper { font-size: 2rem; margin-bottom: 10px; color: var(--color4); }
        .yape-color { color: #742284; }

        .payment-details-section { display: none; animation: fadeIn 0.4s ease-out; }
        .payment-details-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Tarjeta de Crédito */
        .card-visual-wrapper { perspective: 1000px; margin-bottom: 30px; display: flex; justify-content: center; }
        .credit-card-visual {
            width: 340px; height: 210px;
            background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            border-radius: 16px; color: white; padding: 25px;
            position: relative; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            font-family: 'Space Grotesk', monospace;
        }
        .card-chip {
            width: 50px; height: 35px;
            background: linear-gradient(135deg, #d4af37 0%, #f9e295 100%);
            border-radius: 6px; margin-bottom: 25px;
        }
        .card-logo { position: absolute; top: 20px; right: 25px; font-size: 2.5rem; }
        
        /* CORRECCIÓN FUENTE TARJETA */
        .card-number-display {
            font-size: 1.25rem; letter-spacing: 2px; margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5); white-space: nowrap;
        }
        
        .card-details-row { display: flex; justify-content: space-between; font-size: 0.8rem; text-transform: uppercase; }
        .card-details-row span { opacity: 0.7; font-size: 0.65rem; display: block; margin-bottom: 4px; }

        .form-row-split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-with-icon { position: relative; }
        .input-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--color3); font-size: 1.2rem; }
        
        .secure-badge {
            background: #e8f5e9; color: #2e7d32; padding: 12px;
            border-radius: 10px; font-size: 0.9rem; margin-bottom: 25px;
            text-align: center; font-weight: 500;
        }

        /* --- YAPE ESTILOS (RESTAURADOS) --- */
        .yape-container {
            text-align: center; background: #f9f9f9; /* Fondo gris claro como antes */
            padding: 30px; border-radius: 15px;
            border: 2px dashed #ccc; /* Borde punteado como antes */
        }
        .qr-box {
            display: inline-block; margin-bottom: 10px; padding: 10px;
            background: white; border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .qr-image { width: 180px; height: 180px; display: block; }
        
        /* Estilo texto QR */
        .qr-footer-text {
            font-weight: 700; color: var(--color4); margin-bottom: 20px; font-size: 1rem;
        }

        .yape-instructions { text-align: left; margin-bottom: 25px; }
        .yape-instructions ol { padding-left: 20px; margin: 0; }
        .yape-instructions li { margin-bottom: 10px; color: var(--color4); }
        .price-highlight { color: var(--color1); font-size: 1.2rem; }

        .btn-yape {
            background: #742284; color: white; border: none;
            padding: 15px 30px; border-radius: 30px;
            font-weight: bold; font-size: 1.1rem;
            cursor: pointer; width: 100%; transition: 0.3s;
        }
        .btn-yape:hover { background: #5a1a66; transform: scale(1.02); }

        /* --- 3. CORRECCIÓN LOADING CENTRADO TOTAL --- */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw; /* Ocupar todo el ancho */
            height: 100vh; /* Ocupar todo el alto */
            background: rgba(0, 0, 0, 0.85);
            z-index: 99999; /* Encima de todo */
            display: none; /* Oculto por defecto */
            
            /* Magia de Flexbox para centrar */
            justify-content: center; 
            align-items: center; 
            
            color: white;
            backdrop-filter: blur(5px);
        }

        .loader-content {
            /* Asegura que el texto dentro del div también se centre */
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .spinner {
            width: 60px; height: 60px;
            border: 5px solid rgba(255, 192, 0, 0.3);
            border-top: 5px solid var(--color1);
            border-radius: 50%; animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 900px) {
            .checkout-grid { grid-template-columns: 1fr; }
            .checkout-summary-container { order: -1; }
            .resumen-card.sticky-top { position: static; }
        }
    </style>

    <script>
        // 1. Alternar entre Tarjeta y Yape
        function togglePaymentMethod(method) {
            const formTarjeta = document.getElementById('form-tarjeta');
            const formYape = document.getElementById('form-yape');
            const inputMetodo = document.getElementById('inputMetodoPago');

            inputMetodo.value = method;

            if (method === 'tarjeta') {
                formTarjeta.classList.add('active');
                formYape.classList.remove('active');
            } else {
                formTarjeta.classList.remove('active');
                formYape.classList.add('active');
            }
        }

        // 2. Lógica de Tarjeta
        const cardNumberInput = document.getElementById('cardNumber');
        const cardNameInput = document.getElementById('cardName');
        const cardExpiryInput = document.getElementById('cardExpiry');
        const displayNumber = document.getElementById('display-number');
        const displayName = document.getElementById('display-name');
        const displayExpiry = document.getElementById('display-expiry');
        const logoIcon = document.getElementById('card-logo-visual');
        const inputIcon = document.getElementById('card-type-icon');

        cardNumberInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            let formattedValue = '';
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) formattedValue += ' ';
                formattedValue += value[i];
            }
            e.target.value = formattedValue;
            displayNumber.innerText = formattedValue || '#### #### #### ####';

            if (value.startsWith('4')) {
                logoIcon.innerHTML = '<i class="fa-brands fa-cc-visa"></i>';
                inputIcon.className = 'fa-brands fa-cc-visa input-icon';
            } else if (/^5[1-5]/.test(value)) {
                logoIcon.innerHTML = '<i class="fa-brands fa-cc-mastercard"></i>';
                inputIcon.className = 'fa-brands fa-cc-mastercard input-icon';
            } else {
                logoIcon.innerHTML = '<i class="fa-regular fa-credit-card"></i>';
                inputIcon.className = 'fa-regular fa-credit-card input-icon';
            }
        });

        cardNameInput.addEventListener('input', function (e) {
            displayName.innerText = e.target.value.toUpperCase() || 'NOMBRE APELLIDO';
        });

        cardExpiryInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
            displayExpiry.innerText = value || 'MM/YY';
        });

        // 3. Procesar Pago
        document.getElementById('paymentFormCard').addEventListener('submit', function (e) {
            e.preventDefault();
            if (cardNumberInput.value.length < 19) {
                alert("Por favor ingresa un número de tarjeta válido.");
                return;
            }
            mostrarLoader("Procesando pago con Tarjeta...");
            setTimeout(() => { document.getElementById('realForm').submit(); }, 3000);
        });

        function procesarSimulacionYape() {
            mostrarLoader("Verificando depósito Yape...");
            setTimeout(() => {
                const loadingText = document.getElementById('loading-text');
                loadingText.innerText = "¡Pago verificado!";
                loadingText.style.color = "#4caf50";
                setTimeout(() => { document.getElementById('realForm').submit(); }, 1000);
            }, 2500);
        }

        function mostrarLoader(texto) {
            const overlay = document.getElementById('payment-overlay');
            const txt = document.getElementById('loading-text');
            txt.innerText = texto;
            overlay.style.display = 'flex'; // Se activa el flex definido en CSS
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Restaurante Marcos</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    
    <div th:replace="~{fragments/header :: header}"></div>

    <main class="main-content">
        <section class="checkout-page">
            <div class="container my-5">
                <h2 class="text-center mb-4">Finalizar Pedido</h2>
                
                <div class="row">
                    <div class="col-md-8">
                        
                        <div class="checkout-section p-4 mb-4">
                            <h4 class="mb-3">Tus Artículos (<span th:text="${cantidadItems}">0</span>)</h4>
                            <div th:if="${items.isEmpty()}" class="text-center text-muted">
                                El carrito está vacío.
                            </div>
                            <div th:unless="${items.isEmpty()}" class="cart-items-list">
                                <div th:each="item : ${items}" class="cart-item-summary d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                                    <div class="d-flex align-items-center">
                                        <div class="item-info">
                                            <span class="item-qty me-2" th:text="${item.cantidad} + 'x'">1x</span>
                                            <span class="item-name" th:text="${item.plato.nombre}">Plato Ejemplo</span>
                                        </div>
                                    </div>
                                    <span class="item-price" th:text="'S/ ' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}">S/ 0.00</span>
                                </div>
                            </div>
                        </div>

                        <div class="checkout-section p-4 mb-4">
                            <h4 class="mb-3">Dirección de Envío</h4>
                            <form id="payment-form" th:action="@{/carrito/confirmar-pago}" method="post">
                                <div class="mb-3">
                                    <label for="deliveryAddress" class="form-label">Dirección Completa</label>
                                    <input type="text" class="form-control" id="deliveryAddress" name="deliveryAddress" required placeholder="Ej: Av. Primavera 123, Dpto 501, Surco">
                                </div>
                                <div class="mb-3">
                                    <label for="city" class="form-label">Ciudad / Distrito</label>
                                    <input type="text" class="form-control" id="city" name="city" required value="Lima / Miraflores" readonly>
                                </div>
                                
                                <div class="mb-4">
                                    <h4 class="mb-3">Método de Pago</h4>
                                    
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="paymentCard" value="card" checked>
                                        <label class="form-check-label" for="paymentCard">
                                            Tarjeta de Crédito o Débito
                                        </label>
                                    </div>
                                    
                                    <div id="card-details" class="p-3 border rounded">
                                        <div class="mb-3">
                                            <label for="cardType" class="form-label">Tipo de Tarjeta</label>
                                            <select class="form-select" id="cardType" name="cardType" required>
                                                <option value="visa">Visa</option>
                                                <option value="mastercard">Mastercard</option>
                                                <option value="amex">American Express</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label for="cardNumber" class="form-label">Número de Tarjeta</label>
                                            <input type="text" class="form-control" id="cardNumber" name="cardNumber" placeholder="0000 0000 0000 0000" required>
                                        </div>
                                        <div class="row">
                                            <div class="col-6 mb-3">
                                                <label for="cardExpiry" class="form-label">Vencimiento (MM/AA)</label>
                                                <input type="text" class="form-control" id="cardExpiry" name="cardExpiry" placeholder="01/26" required>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <label for="cardCvc" class="form-label">CVC</label>
                                                <input type="text" class="form-control" id="cardCvc" name="cardCvc" placeholder="123" required>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-check mt-3">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="paymentCash" value="cash">
                                        <label class="form-check-label" for="paymentCash">
                                            Pago en Efectivo al Recibir
                                        </label>
                                    </div>
                                    
                                </div>
                                
                                <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}">
                                    Mensaje de error.
                                </div>
                                
                                <button type="submit" class="btn-submit w-100" id="btn-pay-card">
                                    Pagar S/ <span th:text="${#numbers.formatDecimal(totalPagar, 1, 2)}"></span>
                                    (USD <span th:text="${#numbers.formatDecimal(totalPagarUSD, 1, 2)}"></span>)
                                </button>
                                
                            </form>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="checkout-section p-4 sticky-top summary-card">
                            <h4 class="mb-4">Resumen de Pedido</h4>
                            
                            <div class="resumen-detalle d-flex justify-content-between mb-2">
                                <span>Subtotal</span>
                                <span th:text="'S/ ' + ${#numbers.formatDecimal(total, 1, 2)}">S/ 0.00</span>
                            </div>
                            <div class="resumen-detalle d-flex justify-content-between mb-3 border-bottom pb-3">
                                <span>Costo de Envío</span>
                                <span>S/ 5.00</span> 
                            </div>
                            
                            <div class="resumen-total">
                                <span>Total a Pagar</span>
                                <div class="d-flex flex-column align-items-end">
                                    <span class="total-amount" th:text="'S/ ' + ${#numbers.formatDecimal(totalPagar, 1, 2)}">S/ 0.00</span>
                                    <span style="font-size: 1.1rem; font-weight: 500; color: #555;">
                                        ~ <i class="fa-solid fa-dollar-sign"></i> 
                                        <span th:text="${#numbers.formatDecimal(totalPagarUSD, 1, 2)}">0.00</span> USD
                                    </span>
                                </div>
                            </div>
                            
                            <div class="mt-4 text-center">
                                <a th:href="@{/carrito/ver}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fa-solid fa-pen-to-square"></i> Editar Carrito
                                </a>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </section>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <script th:src="@{/scripts/main.js}"></script>
    <script th:inline="javascript">
        // Lógica para mostrar/ocultar campos de tarjeta y actualizar el texto del botón
        document.addEventListener('DOMContentLoaded', function() {
            const paymentCard = document.getElementById('paymentCard');
            const paymentCash = document.getElementById('paymentCash');
            const cardDetails = document.getElementById('card-details');
            const btnPayCard = document.getElementById('btn-pay-card');
            
            // Las variables de Thymeleaf se inyectan en el script
            const totalPagar = /*[[${#numbers.formatDecimal(totalPagar, 1, 2)}]]*/ '0.00';
            const totalPagarUSD = /*[[${#numbers.formatDecimal(totalPagarUSD, 1, 2)}]]*/ '0.00';
            
            function updatePaymentMethod() {
                if (paymentCard.checked) {
                    cardDetails.style.display = 'block';
                    btnPayCard.innerHTML = `Pagar S/ ${totalPagar} (USD ${totalPagarUSD})`;
                } else {
                    cardDetails.style.display = 'none';
                    btnPayCard.textContent = 'Confirmar Pedido (Pagar en Efectivo)';
                }
            }

            paymentCard.addEventListener('change', updatePaymentMethod);
            paymentCash.addEventListener('change', updatePaymentMethod);

            // Inicializar el estado
            updatePaymentMethod();
        });
    </script>
</body>
</html>